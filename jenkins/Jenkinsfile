pipeline {
    agent {
        docker {
            image 'docker:20.10.24-cli'
            args '''
                --network jenkins
                -v /certs/client:/certs/client:ro
                -e DOCKER_HOST=tcp://docker:2376
                -e DOCKER_CERT_PATH=/certs/client
                -e DOCKER_TLS_VERIFY=1
            '''
        }
    }
    environment {
        CI = 'true'
    }
    stages {
        stage('Build') {
            steps {
                sh 'npm install'
            }
        }
        stage('Test') {
            steps {
                sh './jenkins/scripts/test.sh'
            }
        }
        stage('Build and Push Docker Image') {
            steps {
                // Specify an empty credentialsId since the registry is unsecured
                withDockerRegistry([url: "http://local-registry:5000", credentialsId: '']) {
                    sh 'docker build -t local-registry:5000/my-app:latest .'
                    sh 'docker push local-registry:5000/my-app:latest'
                }
            }
        }
    }
}
